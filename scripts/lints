#!/usr/bin/env bash

# shellcheck disable=SC2016
find . -type f -name go.mod | sort | while read -r mod; do
  dir="$(dirname "$mod")"
  name="$(basename "$dir")"
  # get the parent directory when the module is nested semver-style
  if [[ "$name" =~ ^v[0-9]+.*$ ]]; then
    ver="$(basename "$dir")"
    dir="$(dirname "$dir")"
    name="$(basename "$dir")-$ver"
  fi

  moddir="$(dirname "$mod")"

  echo "# auto-generated by scripts/builds. DO NOT EDIT.
name: lint-$name
on:
  push:
    paths:
      - '${moddir#./}/**'
  pull_request:
    paths:
      - '${moddir#./}/**'

jobs:
  lint:
    uses: charmbracelet/meta/.github/workflows/lint.yml@main
    with:
      directory: $(dirname "$mod")/...
" >"./.github/workflows/lint-${name}.yml"
done
